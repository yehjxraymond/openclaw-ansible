---
# Linux-specific Google Chrome installation (apt-based)

- name: Install required packages for Google Chrome
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
    state: present
    update_cache: true

- name: Create directory for Google Chrome GPG key
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'

- name: Add Google Chrome GPG key
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      curl -fsSL https://dl.google.com/linux/linux_signing_key.pub | \
        gpg --dearmor -o /etc/apt/keyrings/google-chrome.gpg
      chmod a+r /etc/apt/keyrings/google-chrome.gpg
    creates: /etc/apt/keyrings/google-chrome.gpg
    executable: /bin/bash

- name: Add Google Chrome repository
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      echo "deb [arch=$(dpkg --print-architecture) \
        signed-by=/etc/apt/keyrings/google-chrome.gpg] \
        https://dl.google.com/linux/chrome/deb/ stable main" | \
        tee /etc/apt/sources.list.d/google-chrome.list > /dev/null
    creates: /etc/apt/sources.list.d/google-chrome.list
    executable: /bin/bash

- name: Update apt cache after adding Google Chrome repo
  ansible.builtin.apt:
    update_cache: true

- name: Install Google Chrome and virtual display dependencies
  ansible.builtin.apt:
    name:
      - google-chrome-stable
      - xvfb
      - libxss1
      - libappindicator3-1
      - fonts-liberation
      - xdg-utils
      - dbus-x11
    state: present

- name: Create Chrome user-data-dir for OpenClaw
  ansible.builtin.file:
    path: "{{ openclaw_home }}/.config/openclaw-chrome"
    state: directory
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: '0755'

- name: Create Chrome cache directory
  ansible.builtin.file:
    path: "{{ openclaw_home }}/.cache"
    state: directory
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: '0755'

- name: Deploy Xvfb systemd service
  ansible.builtin.template:
    src: xvfb.service.j2
    dest: /etc/systemd/system/xvfb.service
    mode: '0644'
  notify: Restart xvfb

- name: Deploy Chrome systemd service
  ansible.builtin.template:
    src: openclaw-chrome.service.j2
    dest: /etc/systemd/system/openclaw-chrome.service
    mode: '0644'
  notify: Restart openclaw-chrome

- name: Enable and start Xvfb service
  ansible.builtin.systemd:
    name: xvfb
    state: started
    enabled: true
    daemon_reload: true

- name: Enable and start Chrome service
  ansible.builtin.systemd:
    name: openclaw-chrome
    state: started
    enabled: true
    daemon_reload: true
