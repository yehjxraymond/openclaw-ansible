---
- name: Create Clawdbot directories
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: "{{ clawdbot_config_dir }}", mode: '0755' }
    - { path: "{{ clawdbot_config_dir }}/sessions", mode: '0755' }
    - { path: "{{ clawdbot_config_dir }}/credentials", mode: '0700' }

- name: Create pnpm directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0755'
  loop:
    - "{{ clawdbot_home }}/.local/share/pnpm"
    - "{{ clawdbot_home }}/.local/bin"

- name: Configure pnpm for clawdbot user
  ansible.builtin.shell:
    cmd: |
      pnpm config set global-dir {{ clawdbot_home }}/.local/share/pnpm
      pnpm config set global-bin-dir {{ clawdbot_home }}/.local/bin
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"

- name: Install Clawdbot globally as clawdbot user
  ansible.builtin.shell:
    cmd: pnpm add -g clawdbot@latest
    executable: /bin/bash
  become: true
  become_user: "{{ clawdbot_user }}"
  environment:
    PNPM_HOME: "{{ clawdbot_home }}/.local/share/pnpm"
    PATH: "{{ clawdbot_home }}/.local/bin:{{ ansible_env.PATH }}"

- name: Add pnpm bin to PATH in .bashrc
  ansible.builtin.lineinfile:
    path: "{{ clawdbot_home }}/.bashrc"
    line: 'export PATH="{{ clawdbot_home }}/.local/bin:$PATH"'
    create: true
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0644'

- name: Generate Clawdbot config template
  ansible.builtin.template:
    src: clawdbot-config.yml.j2
    dest: "{{ clawdbot_config_dir }}/config.yml"
    owner: "{{ clawdbot_user }}"
    group: "{{ clawdbot_user }}"
    mode: '0644'
    force: false

- name: Generate systemd service file for Clawdbot
  ansible.builtin.template:
    src: clawdbot-host.service.j2
    dest: /etc/systemd/system/clawdbot.service
    owner: root
    group: root
    mode: '0644'

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true

- name: Enable and start Clawdbot service
  ansible.builtin.systemd:
    name: clawdbot
    enabled: true
    state: started
